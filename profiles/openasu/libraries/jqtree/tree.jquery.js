// Generated by CoffeeScript 1.7.1
(function(){var $,BorderDropHint,DragAndDropHandler,DragElement,ElementsRenderer,FolderElement,GhostDropHint,HitAreasGenerator,JqTreeWidget,KeyHandler,MouseWidget,Node,NodeElement,Position,SaveStateHandler,ScrollHandler,SelectNodeHandler,SimpleWidget,VisibleNodeIterator,get_json_stringify_function,html_escape,indexOf,isInt,__version__,_indexOf,__slice=[].slice,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};__version__="0.22.0",$=this.jQuery,SimpleWidget=function(){function SimpleWidget(el,options){this.$el=$(el),this.options=$.extend({},this.defaults,options)}return SimpleWidget.prototype.defaults={},SimpleWidget.prototype.destroy=function(){return this._deinit()},SimpleWidget.prototype._init=function(){return null},SimpleWidget.prototype._deinit=function(){return null},SimpleWidget.register=function(widget_class,widget_name){var callFunction,createWidget,destroyWidget,getDataKey,getWidgetData;return getDataKey=function(){return"simple_widget_"+widget_name},getWidgetData=function(el,data_key){var widget;return widget=$.data(el,data_key),widget&&widget instanceof SimpleWidget?widget:null},createWidget=function($el,options){var data_key,el,existing_widget,widget,_i,_len;data_key=getDataKey();for(_i=0,_len=$el.length;_i<_len;_i++)el=$el[_i],existing_widget=getWidgetData(el,data_key),existing_widget||(widget=new widget_class(el,options),$.data(el,data_key)||$.data(el,data_key,widget),widget._init());return $el},destroyWidget=function($el){var data_key,el,widget,_i,_len,_results;data_key=getDataKey(),_results=[];for(_i=0,_len=$el.length;_i<_len;_i++)el=$el[_i],widget=getWidgetData(el,data_key),widget&&widget.destroy(),_results.push($.removeData(el,data_key));return _results},callFunction=function($el,function_name,args){var el,result,widget,widget_function,_i,_len;result=null;for(_i=0,_len=$el.length;_i<_len;_i++)el=$el[_i],widget=$.data(el,getDataKey()),widget&&widget instanceof SimpleWidget&&(widget_function=widget[function_name],widget_function&&typeof widget_function=="function"&&(result=widget_function.apply(widget,args)));return result},$.fn[widget_name]=function(){var $el,args,argument1,function_name,options;argument1=arguments[0],args=2<=arguments.length?__slice.call(arguments,1):[],$el=this;if(argument1===void 0||typeof argument1=="object")return options=argument1,createWidget($el,options);if(typeof argument1=="string"&&argument1[0]!=="_")return function_name=argument1,function_name==="destroy"?destroyWidget($el):callFunction($el,function_name,args)}},SimpleWidget}(),this.SimpleWidget=SimpleWidget,MouseWidget=function(_super){function MouseWidget(){return MouseWidget.__super__.constructor.apply(this,arguments)}return __extends(MouseWidget,_super),MouseWidget.is_mouse_handled=!1,MouseWidget.prototype._init=function(){return this.$el.bind("mousedown.mousewidget",$.proxy(this._mouseDown,this)),this.$el.bind("touchstart.mousewidget",$.proxy(this._touchStart,this)),this.is_mouse_started=!1,this.mouse_delay=0,this._mouse_delay_timer=null,this._is_mouse_delay_met=!0,this.mouse_down_info=null},MouseWidget.prototype._deinit=function(){var $document;return this.$el.unbind("mousedown.mousewidget"),this.$el.unbind("touchstart.mousewidget"),$document=$(document),$document.unbind("mousemove.mousewidget"),$document.unbind("mouseup.mousewidget")},MouseWidget.prototype._mouseDown=function(e){var result;if(e.which!==1)return;return result=this._handleMouseDown(e,this._getPositionInfo(e)),result&&e.preventDefault(),result},MouseWidget.prototype._handleMouseDown=function(e,position_info){if(MouseWidget.is_mouse_handled)return;this.is_mouse_started&&this._handleMouseUp(position_info),this.mouse_down_info=position_info;if(!this._mouseCapture(position_info))return;return this._handleStartMouse(),this.is_mouse_handled=!0,!0},MouseWidget.prototype._handleStartMouse=function(){var $document;$document=$(document),$document.bind("mousemove.mousewidget",$.proxy(this._mouseMove,this)),$document.bind("touchmove.mousewidget",$.proxy(this._touchMove,this)),$document.bind("mouseup.mousewidget",$.proxy(this._mouseUp,this)),$document.bind("touchend.mousewidget",$.proxy(this._touchEnd,this));if(this.mouse_delay)return this._startMouseDelayTimer()},MouseWidget.prototype._startMouseDelayTimer=function(){return this._mouse_delay_timer&&clearTimeout(this._mouse_delay_timer),this._mouse_delay_timer=setTimeout(function(_this){return function(){return _this._is_mouse_delay_met=!0}}(this),this.mouse_delay),this._is_mouse_delay_met=!1},MouseWidget.prototype._mouseMove=function(e){return this._handleMouseMove(e,this._getPositionInfo(e))},MouseWidget.prototype._handleMouseMove=function(e,position_info){return this.is_mouse_started?(this._mouseDrag(position_info),e.preventDefault()):this.mouse_delay&&!this._is_mouse_delay_met?!0:(this.is_mouse_started=this._mouseStart(this.mouse_down_info)!==!1,this.is_mouse_started?this._mouseDrag(position_info):this._handleMouseUp(position_info),!this.is_mouse_started)},MouseWidget.prototype._getPositionInfo=function(e){return{page_x:e.pageX,page_y:e.pageY,target:e.target,original_event:e}},MouseWidget.prototype._mouseUp=function(e){return this._handleMouseUp(this._getPositionInfo(e))},MouseWidget.prototype._handleMouseUp=function(position_info){var $document;$document=$(document),$document.unbind("mousemove.mousewidget"),$document.unbind("touchmove.mousewidget"),$document.unbind("mouseup.mousewidget"),$document.unbind("touchend.mousewidget"),this.is_mouse_started&&(this.is_mouse_started=!1,this._mouseStop(position_info))},MouseWidget.prototype._mouseCapture=function(position_info){return!0},MouseWidget.prototype._mouseStart=function(position_info){return null},MouseWidget.prototype._mouseDrag=function(position_info){return null},MouseWidget.prototype._mouseStop=function(position_info){return null},MouseWidget.prototype.setMouseDelay=function(mouse_delay){return this.mouse_delay=mouse_delay},MouseWidget.prototype._touchStart=function(e){var touch;if(e.originalEvent.touches.length>1)return;return touch=e.originalEvent.changedTouches[0],this._handleMouseDown(e,this._getPositionInfo(touch))},MouseWidget.prototype._touchMove=function(e){var touch;if(e.originalEvent.touches.length>1)return;return touch=e.originalEvent.changedTouches[0],this._handleMouseMove(e,this._getPositionInfo(touch))},MouseWidget.prototype._touchEnd=function(e){var touch;if(e.originalEvent.touches.length>1)return;return touch=e.originalEvent.changedTouches[0],this._handleMouseUp(this._getPositionInfo(touch))},MouseWidget}(SimpleWidget),this.Tree={},$=this.jQuery,Position={getName:function(position){return Position.strings[position-1]},nameToIndex:function(name){var i,_i,_ref;for(i=_i=1,_ref=Position.strings.length;1<=_ref?_i<=_ref:_i>=_ref;i=1<=_ref?++_i:--_i)if(Position.strings[i-1]===name)return i;return 0}},Position.BEFORE=1,Position.AFTER=2,Position.INSIDE=3,Position.NONE=4,Position.strings=["before","after","inside","none"],this.Tree.Position=Position,Node=function(){function Node(o,is_root,node_class){is_root==null&&(is_root=!1),node_class==null&&(node_class=Node),this.setData(o),this.children=[],this.parent=null,is_root&&(this.id_mapping={},this.tree=this,this.node_class=node_class)}return Node.prototype.setData=function(o){var key,value,_results;if(typeof o!="object")return this.name=o;_results=[];for(key in o)value=o[key],key==="label"?_results.push(this.name=value):_results.push(this[key]=value);return _results},Node.prototype.initFromData=function(data){var addChildren,addNode;return addNode=function(_this){return function(node_data){_this.setData(node_data);if(node_data.children)return addChildren(node_data.children)}}(this),addChildren=function(_this){return function(children_data){var child,node,_i,_len;for(_i=0,_len=children_data.length;_i<_len;_i++)child=children_data[_i],node=new _this.tree.node_class(""),node.initFromData(child),_this.addChild(node);return null}}(this),addNode(data),null},Node.prototype.loadFromData=function(data){var node,o,_i,_len;this.removeChildren();for(_i=0,_len=data.length;_i<_len;_i++)o=data[_i],node=new this.tree.node_class(o),this.addChild(node),typeof o=="object"&&o.children&&node.loadFromData(o.children);return null},Node.prototype.addChild=function(node){return this.children.push(node),node._setParent(this)},Node.prototype.addChildAtPosition=function(node,index){return this.children.splice(index,0,node),node._setParent(this)},Node.prototype._setParent=function(parent){return this.parent=parent,this.tree=parent.tree,this.tree.addNodeToIndex(this)},Node.prototype.removeChild=function(node){return node.removeChildren(),this._removeChild(node)},Node.prototype._removeChild=function(node){return this.children.splice(this.getChildIndex(node),1),this.tree.removeNodeFromIndex(node)},Node.prototype.getChildIndex=function(node){return $.inArray(node,this.children)},Node.prototype.hasChildren=function(){return this.children.length!==0},Node.prototype.isFolder=function(){return this.hasChildren()||this.load_on_demand},Node.prototype.iterate=function(callback){var _iterate;return _iterate=function(_this){return function(node,level){var child,result,_i,_len,_ref;if(node.children){_ref=node.children;for(_i=0,_len=_ref.length;_i<_len;_i++)child=_ref[_i],result=callback(child,level),_this.hasChildren()&&result&&_iterate(child,level+1);return null}}}(this),_iterate(this,0),null},Node.prototype.moveNode=function(moved_node,target_node,position){if(moved_node.isParentOf(target_node))return;moved_node.parent._removeChild(moved_node);if(position===Position.AFTER)return target_node.parent.addChildAtPosition(moved_node,target_node.parent.getChildIndex(target_node)+1);if(position===Position.BEFORE)return target_node.parent.addChildAtPosition(moved_node,target_node.parent.getChildIndex(target_node));if(position===Position.INSIDE)return target_node.addChildAtPosition(moved_node,0)},Node.prototype.getData=function(){var getDataFromNodes;return getDataFromNodes=function(_this){return function(nodes){var data,k,node,tmp_node,v,_i,_len;data=[];for(_i=0,_len=nodes.length;_i<_len;_i++){node=nodes[_i],tmp_node={};for(k in node)v=node[k],k!=="parent"&&k!=="children"&&k!=="element"&&k!=="tree"&&Object.prototype.hasOwnProperty.call(node,k)&&(tmp_node[k]=v);node.hasChildren()&&(tmp_node.children=getDataFromNodes(node.children)),data.push(tmp_node)}return data}}(this),getDataFromNodes(this.children)},Node.prototype.getNodeByName=function(name){var result;return result=null,this.iterate(function(node){return node.name===name?(result=node,!1):!0}),result},Node.prototype.addAfter=function(node_info){var child_index,node;return this.parent?(node=new this.tree.node_class(node_info),child_index=this.parent.getChildIndex(this),this.parent.addChildAtPosition(node,child_index+1),node):null},Node.prototype.addBefore=function(node_info){var child_index,node;return this.parent?(node=new this.tree.node_class(node_info),child_index=this.parent.getChildIndex(this),this.parent.addChildAtPosition(node,child_index),node):null},Node.prototype.addParent=function(node_info){var child,new_parent,original_parent,_i,_len,_ref;if(!this.parent)return null;new_parent=new this.tree.node_class(node_info),new_parent._setParent(this.tree),original_parent=this.parent,_ref=original_parent.children;for(_i=0,_len=_ref.length;_i<_len;_i++)child=_ref[_i],new_parent.addChild(child);return original_parent.children=[],original_parent.addChild(new_parent),new_parent},Node.prototype.remove=function(){if(this.parent)return this.parent.removeChild(this),this.parent=null},Node.prototype.append=function(node_info){var node;return node=new this.tree.node_class(node_info),this.addChild(node),node},Node.prototype.prepend=function(node_info){var node;return node=new this.tree.node_class(node_info),this.addChildAtPosition(node,0),node},Node.prototype.isParentOf=function(node){var parent;parent=node.parent;while(parent){if(parent===this)return!0;parent=parent.parent}return!1},Node.prototype.getLevel=function(){var level,node;level=0,node=this;while(node.parent)level+=1,node=node.parent;return level},Node.prototype.getNodeById=function(node_id){return this.id_mapping[node_id]},Node.prototype.addNodeToIndex=function(node){if(node.id!=null)return this.id_mapping[node.id]=node},Node.prototype.removeNodeFromIndex=function(node){if(node.id!=null)return delete this.id_mapping[node.id]},Node.prototype.removeChildren=function(){return this.iterate(function(_this){return function(child){return _this.tree.removeNodeFromIndex(child),!0}}(this)),this.children=[]},Node.prototype.getPreviousSibling=function(){var previous_index;return this.parent?(previous_index=this.parent.getChildIndex(this)-1,previous_index>=0?this.parent.children[previous_index]:null):null},Node.prototype.getNextSibling=function(){var next_index;return this.parent?(next_index=this.parent.getChildIndex(this)+1,next_index<this.parent.children.length?this.parent.children[next_index]:null):null},Node.prototype.getNodesByProperty=function(key,value){return this.filter(function(node){return node[key]===value})},Node.prototype.filter=function(f){var result;return result=[],this.iterate(function(node){return f(node)&&result.push(node),!0}),result},Node}(),this.Tree.Node=Node,ElementsRenderer=function(){function ElementsRenderer(tree_widget){this.tree_widget=tree_widget,this.opened_icon_element=this.createButtonElement(tree_widget.options.openedIcon),this.closed_icon_element=this.createButtonElement(tree_widget.options.closedIcon)}return ElementsRenderer.prototype.render=function(from_node){return from_node&&from_node.parent?this.renderFromNode(from_node):this.renderFromRoot()},ElementsRenderer.prototype.renderNode=function(node){var li,parent_node_element,previous_node;$(node.element).remove(),parent_node_element=new NodeElement(node.parent,this.tree_widget),li=this.createLi(node),this.attachNodeData(node,li),previous_node=node.getPreviousSibling(),previous_node?$(previous_node.element).after(li):parent_node_element.getUl().prepend(li);if(node.children)return this.renderFromNode(node)},ElementsRenderer.prototype.renderFromRoot=function(){var $element;return $element=this.tree_widget.element,$element.empty(),this.createDomElements($element[0],this.tree_widget.tree.children,!0,!0)},ElementsRenderer.prototype.renderFromNode=function(from_node){var node_element;return node_element=this.tree_widget._getNodeElementForNode(from_node),node_element.getUl().remove(),this.createDomElements(node_element.$element[0],from_node.children,!1,!1)},ElementsRenderer.prototype.createDomElements=function(element,children,is_root_node,is_open){var child,li,ul,_i,_len;ul=this.createUl(is_root_node),element.appendChild(ul);for(_i=0,_len=children.length;_i<_len;_i++)child=children[_i],li=this.createLi(child),ul.appendChild(li),this.attachNodeData(child,li),child.hasChildren()&&this.createDomElements(li,child.children,!1,child.is_open);return null},ElementsRenderer.prototype.attachNodeData=function(node,li){return node.element=li,$(li).data("node",node)},ElementsRenderer.prototype.createUl=function(is_root_node){var class_string,ul;return is_root_node?class_string="jqtree-tree":class_string="",ul=document.createElement("ul"),ul.className="jqtree_common "+class_string,ul},ElementsRenderer.prototype.createLi=function(node){var li;return node.isFolder()?li=this.createFolderLi(node):li=this.createNodeLi(node),this.tree_widget.options.onCreateLi&&this.tree_widget.options.onCreateLi(node,$(li)),li},ElementsRenderer.prototype.createFolderLi=function(node){var button_classes,button_link,div,escaped_name,folder_classes,icon_element,li,title_span;return button_classes=this.getButtonClasses(node),folder_classes=this.getFolderClasses(node),escaped_name=this.escapeIfNecessary(node.name),node.is_open?icon_element=this.opened_icon_element:icon_element=this.closed_icon_element,li=document.createElement("li"),li.className="jqtree_common "+folder_classes,div=document.createElement("div"),div.className="jqtree-element jqtree_common",li.appendChild(div),button_link=document.createElement("a"),button_link.className="jqtree_common "+button_classes,button_link.appendChild(icon_element.cloneNode()),div.appendChild(button_link),title_span=document.createElement("span"),title_span.className="jqtree_common jqtree-title jqtree-title-folder",div.appendChild(title_span),title_span.innerHTML=escaped_name,li},ElementsRenderer.prototype.createNodeLi=function(node){var class_string,div,escaped_name,li,li_classes,title_span;return li_classes=["jqtree_common"],this.tree_widget.select_node_handler&&this.tree_widget.select_node_handler.isNodeSelected(node)&&li_classes.push("jqtree-selected"),class_string=li_classes.join(" "),escaped_name=this.escapeIfNecessary(node.name),li=document.createElement("li"),li.className=class_string,div=document.createElement("div"),div.className="jqtree-element jqtree_common",li.appendChild(div),title_span=document.createElement("span"),title_span.className="jqtree-title jqtree_common",title_span.innerHTML=escaped_name,div.appendChild(title_span),li},ElementsRenderer.prototype.getButtonClasses=function(node){var classes;return classes=["jqtree-toggler"],node.is_open||classes.push("jqtree-closed"),classes.join(" ")},ElementsRenderer.prototype.getFolderClasses=function(node){var classes;return classes=["jqtree-folder"],node.is_open||classes.push("jqtree-closed"),this.tree_widget.select_node_handler&&this.tree_widget.select_node_handler.isNodeSelected(node)&&classes.push("jqtree-selected"),classes.join(" ")},ElementsRenderer.prototype.escapeIfNecessary=function(value){return this.tree_widget.options.autoEscape?html_escape(value):value},ElementsRenderer.prototype.createButtonElement=function(value){var div;return typeof value=="string"?(div=document.createElement("div"),div.innerHTML=value,document.createTextNode(div.innerHTML)):$(value)[0]},ElementsRenderer}(),JqTreeWidget=function(_super){function JqTreeWidget(){return JqTreeWidget.__super__.constructor.apply(this,arguments)}return __extends(JqTreeWidget,_super),JqTreeWidget.prototype.defaults={autoOpen:!1,saveState:!1,dragAndDrop:!1,selectable:!0,useContextMenu:!0,onCanSelectNode:null,onSetStateFromStorage:null,onGetStateFromStorage:null,onCreateLi:null,onIsMoveHandle:null,onCanMove:null,onCanMoveTo:null,onLoadFailed:null,autoEscape:!0,dataUrl:null,closedIcon:"&#x25ba;",openedIcon:"&#x25bc;",slide:!0,nodeClass:Node,dataFilter:null,keyboardSupport:!0,openFolderDelay:500},JqTreeWidget.prototype.toggle=function(node,slide){return slide==null&&(slide=null),slide===null&&(slide=this.options.slide),node.is_open?this.closeNode(node,slide):this.openNode(node,slide)},JqTreeWidget.prototype.getTree=function(){return this.tree},JqTreeWidget.prototype.selectNode=function(node){return this._selectNode(node,!1)},JqTreeWidget.prototype._selectNode=function(node,must_toggle){var canSelect,deselected_node,openParents,saveState;must_toggle==null&&(must_toggle=!1);if(!this.select_node_handler)return;canSelect=function(_this){return function(){return _this.options.onCanSelectNode?_this.options.selectable&&_this.options.onCanSelectNode(node):_this.options.selectable}}(this),openParents=function(_this){return function(){var parent;parent=node.parent;if(parent&&parent.parent&&!parent.is_open)return _this.openNode(parent,!1)}}(this),saveState=function(_this){return function(){if(_this.options.saveState)return _this.save_state_handler.saveState()}}(this);if(!node){this._deselectCurrentNode(),saveState();return}if(!canSelect())return;return this.select_node_handler.isNodeSelected(node)?must_toggle&&(this._deselectCurrentNode(),this._triggerEvent("tree.select",{node:null,previous_node:node})):(deselected_node=this.getSelectedNode(),this._deselectCurrentNode(),this.addToSelection(node),this._triggerEvent("tree.select",{node:node,deselected_node:deselected_node}),openParents()),saveState()},JqTreeWidget.prototype.getSelectedNode=function(){return this.select_node_handler.getSelectedNode()},JqTreeWidget.prototype.toJson=function(){return JSON.stringify(this.tree.getData())},JqTreeWidget.prototype.loadData=function(data,parent_node){return this._loadData(data,parent_node)},JqTreeWidget.prototype.loadDataFromUrl=function(url,parent_node,on_finished){return $.type(url)!=="string"&&(on_finished=parent_node,parent_node=url,url=null),this._loadDataFromUrl(url,parent_node,on_finished)},JqTreeWidget.prototype.reload=function(){return this.loadDataFromUrl()},JqTreeWidget.prototype._loadDataFromUrl=function(url_info,parent_node,on_finished){var $el,addLoadingClass,handeLoadData,loadDataFromUrlInfo,parseUrlInfo,removeLoadingClass;$el=null,addLoadingClass=function(_this){return function(){var folder_element;return parent_node?(folder_element=new FolderElement(parent_node,_this),$el=folder_element.getLi()):$el=_this.element,$el.addClass("jqtree-loading")}}(this),removeLoadingClass=function(_this){return function(){if($el)return $el.removeClass("jqtree-loading")}}(this),parseUrlInfo=function(_this){return function(){$.type(url_info)==="string"&&(url_info={url:url_info});if(!url_info.method)return url_info.method="get"}}(this),handeLoadData=function(_this){return function(data){removeLoadingClass(),_this._loadData(data,parent_node);if(on_finished&&$.isFunction(on_finished))return on_finished()}}(this),loadDataFromUrlInfo=function(_this){return function(){return parseUrlInfo(),$.ajax({url:url_info.url,data:url_info.data,type:url_info.method.toUpperCase(),cache:!1,dataType:"json",success:function(response){var data;return $.isArray(response)||typeof response=="object"?data=response:data=$.parseJSON(response),_this.options.dataFilter&&(data=_this.options.dataFilter(data)),handeLoadData(data)},error:function(response){removeLoadingClass();if(_this.options.onLoadFailed)return _this.options.onLoadFailed(response)}})}}(this),url_info||(url_info=this._getDataUrlInfo(parent_node)),addLoadingClass();if(!url_info)removeLoadingClass();else{if(!$.isArray(url_info))return loadDataFromUrlInfo();handeLoadData(url_info)}},JqTreeWidget.prototype._loadData=function(data,parent_node){var n,selected_nodes_under_parent,_i,_len;if(!data)return;this._triggerEvent("tree.load_data",{tree_data:data});if(!parent_node)this._initTree(data);else{selected_nodes_under_parent=this.select_node_handler.getSelectedNodesUnder(parent_node);for(_i=0,_len=selected_nodes_under_parent.length;_i<_len;_i++)n=selected_nodes_under_parent[_i],this.select_node_handler.removeFromSelection(n);parent_node.loadFromData(data),parent_node.load_on_demand=!1,this._refreshElements(parent_node.parent)}if(this.isDragging())return this.dnd_handler.refresh()},JqTreeWidget.prototype.getNodeById=function(node_id){return this.tree.getNodeById(node_id)},JqTreeWidget.prototype.getNodeByName=function(name){return this.tree.getNodeByName(name)},JqTreeWidget.prototype.openNode=function(node,slide){return slide==null&&(slide=null),slide===null&&(slide=this.options.slide),this._openNode(node,slide)},JqTreeWidget.prototype._openNode=function(node,slide,on_finished){var doOpenNode,parent;slide==null&&(slide=!0),doOpenNode=function(_this){return function(_node,_slide,_on_finished){var folder_element;return folder_element=new FolderElement(_node,_this),folder_element.open(_on_finished,_slide)}}(this);if(node.isFolder()){if(node.load_on_demand)return this._loadFolderOnDemand(node,slide,on_finished);parent=node.parent;while(parent&&!parent.is_open)parent.parent&&doOpenNode(parent,!1,null),parent=parent.parent;return doOpenNode(node,slide,on_finished),this._saveState()}},JqTreeWidget.prototype._loadFolderOnDemand=function(node,slide,on_finished){return slide==null&&(slide=!0),this._loadDataFromUrl(null,node,function(_this){return function(){return _this._openNode(node,slide,on_finished)}}(this))},JqTreeWidget.prototype.closeNode=function(node,slide){slide==null&&(slide=null),slide===null&&(slide=this.options.slide);if(node.isFolder())return(new FolderElement(node,this)).close(slide),this._saveState()},JqTreeWidget.prototype.isDragging=function(){return this.dnd_handler?this.dnd_handler.is_dragging:!1},JqTreeWidget.prototype.refreshHitAreas=function(){return this.dnd_handler.refresh()},JqTreeWidget.prototype.addNodeAfter=function(new_node_info,existing_node){var new_node;return new_node=existing_node.addAfter(new_node_info),this._refreshElements(existing_node.parent),new_node},JqTreeWidget.prototype.addNodeBefore=function(new_node_info,existing_node){var new_node;return new_node=existing_node.addBefore(new_node_info),this._refreshElements(existing_node.parent),new_node},JqTreeWidget.prototype.addParentNode=function(new_node_info,existing_node){var new_node;return new_node=existing_node.addParent(new_node_info),this._refreshElements(new_node.parent),new_node},JqTreeWidget.prototype.removeNode=function(node){var parent;parent=node.parent;if(parent)return this.select_node_handler.removeFromSelection(node,!0),node.remove(),this._refreshElements(parent.parent)},JqTreeWidget.prototype.appendNode=function(new_node_info,parent_node){var is_already_folder_node,node;return parent_node||(parent_node=this.tree),is_already_folder_node=parent_node.isFolder(),node=parent_node.append(new_node_info),is_already_folder_node?this._refreshElements(parent_node):this._refreshElements(parent_node.parent),node},JqTreeWidget.prototype.prependNode=function(new_node_info,parent_node){var node;return parent_node||(parent_node=this.tree),node=parent_node.prepend(new_node_info),this._refreshElements(parent_node),node},JqTreeWidget.prototype.updateNode=function(node,data){var id_is_changed;return id_is_changed=data.id&&data.id!==node.id,id_is_changed&&this.tree.removeNodeFromIndex(node),node.setData(data),id_is_changed&&this.tree.addNodeToIndex(node),this.renderer.renderNode(node),this._selectCurrentNode()},JqTreeWidget.prototype.moveNode=function(node,target_node,position){var position_index;return position_index=Position.nameToIndex(position),this.tree.moveNode(node,target_node,position_index),this._refreshElements()},JqTreeWidget.prototype.getStateFromStorage=function(){return this.save_state_handler.getStateFromStorage()},JqTreeWidget.prototype.addToSelection=function(node){if(node)return this.select_node_handler.addToSelection(node),this._getNodeElementForNode(node).select(),this._saveState()},JqTreeWidget.prototype.getSelectedNodes=function(){return this.select_node_handler.getSelectedNodes()},JqTreeWidget.prototype.isNodeSelected=function(node){return this.select_node_handler.isNodeSelected(node)},JqTreeWidget.prototype.removeFromSelection=function(node){return this.select_node_handler.removeFromSelection(node),this._getNodeElementForNode(node).deselect(),this._saveState()},JqTreeWidget.prototype.scrollToNode=function(node){var $element,top;return $element=$(node.element),top=$element.offset().top-this.$el.offset().top,this.scroll_handler.scrollTo(top)},JqTreeWidget.prototype.getState=function(){return this.save_state_handler.getState()},JqTreeWidget.prototype.setState=function(state){return this.save_state_handler.setState(state),this._refreshElements()},JqTreeWidget.prototype.setOption=function(option,value){return this.options[option]=value},JqTreeWidget.prototype.getVersion=function(){return __version__},JqTreeWidget.prototype._init=function(){JqTreeWidget.__super__._init.call(this),this.element=this.$el,this.mouse_delay=300,this.is_initialized=!1,this.renderer=new ElementsRenderer(this),typeof SaveStateHandler!="undefined"&&SaveStateHandler!==null?this.save_state_handler=new SaveStateHandler(this):this.options.saveState=!1,typeof SelectNodeHandler!="undefined"&&SelectNodeHandler!==null&&(this.select_node_handler=new SelectNodeHandler(this)),typeof DragAndDropHandler!="undefined"&&DragAndDropHandler!==null?this.dnd_handler=new DragAndDropHandler(this):this.options.dragAndDrop=!1,typeof ScrollHandler!="undefined"&&ScrollHandler!==null&&(this.scroll_handler=new ScrollHandler(this)),typeof KeyHandler!="undefined"&&KeyHandler!==null&&typeof SelectNodeHandler!="undefined"&&SelectNodeHandler!==null&&(this.key_handler=new KeyHandler(this)),this._initData(),this.element.click($.proxy(this._click,this)),this.element.dblclick($.proxy(this._dblclick,this));if(this.options.useContextMenu)return this.element.bind("contextmenu",$.proxy(this._contextmenu,this))},JqTreeWidget.prototype._deinit=function(){return this.element.empty(),this.element.unbind(),this.key_handler.deinit(),this.tree=null,JqTreeWidget.__super__._deinit.call(this)},JqTreeWidget.prototype._initData=function(){return this.options.data?this._loadData(this.options.data):this._loadDataFromUrl(this._getDataUrlInfo())},JqTreeWidget.prototype._getDataUrlInfo=function(node){var data_url,getUrlFromString;return data_url=this.options.dataUrl||this.element.data("url"),getUrlFromString=function(_this){return function(){var data,selected_node_id,url_info;return url_info={url:data_url},node&&node.id?(data={node:node.id},url_info.data=data):(selected_node_id=_this._getNodeIdToBeSelected(),selected_node_id&&(data={selected_node:selected_node_id},url_info.data=data)),url_info}}(this),$.isFunction(data_url)?data_url(node):$.type(data_url)==="string"?getUrlFromString():data_url},JqTreeWidget.prototype._getNodeIdToBeSelected=function(){return this.options.saveState?this.save_state_handler.getNodeIdToBeSelected():null},JqTreeWidget.prototype._initTree=function(data){this.tree=new this.options.nodeClass(null,!0,this.options.nodeClass),this.select_node_handler&&this.select_node_handler.clear(),this.tree.loadFromData(data),this._openNodes(),this._refreshElements();if(!this.is_initialized)return this.is_initialized=!0,this._triggerEvent("tree.init")},JqTreeWidget.prototype._openNodes=function(){var max_level;if(this.options.saveState&&this.save_state_handler.restoreState())return;if(this.options.autoOpen===!1)return;return this.options.autoOpen===!0?max_level=-1:max_level=parseInt(this.options.autoOpen),this.tree.iterate(function(node,level){return node.hasChildren()&&(node.is_open=!0),level!==max_level})},JqTreeWidget.prototype._refreshElements=function(from_node){return from_node==null&&(from_node=null),this.renderer.render(from_node),this._triggerEvent("tree.refresh")},JqTreeWidget.prototype._click=function(e){var click_target,event,node;click_target=this._getClickTarget(e.target);if(click_target){if(click_target.type==="button")return this.toggle(click_target.node,this.options.slide),e.preventDefault(),e.stopPropagation();if(click_target.type==="label"){node=click_target.node,event=this._triggerEvent("tree.click",{node:node,click_event:e});if(!event.isDefaultPrevented())return this._selectNode(node,!0)}}},JqTreeWidget.prototype._dblclick=function(e){var click_target;click_target=this._getClickTarget(e.target);if(click_target&&click_target.type==="label")return this._triggerEvent("tree.dblclick",{node:click_target.node,click_event:e})},JqTreeWidget.prototype._getClickTarget=function(element){var $button,$el,$target,node;$target=$(element),$button=$target.closest(".jqtree-toggler");if($button.length){node=this._getNode($button);if(node)return{type:"button",node:node}}else{$el=$target.closest(".jqtree-element");if($el.length){node=this._getNode($el);if(node)return{type:"label",node:node}}}return null},JqTreeWidget.prototype._getNode=function($element){var $li;return $li=$element.closest("li.jqtree_common"),$li.length===0?null:$li.data("node")},JqTreeWidget.prototype._getNodeElementForNode=function(node){return node.isFolder()?new FolderElement(node,this):new NodeElement(node,this)},JqTreeWidget.prototype._getNodeElement=function($element){var node;return node=this._getNode($element),node?this._getNodeElementForNode(node):null},JqTreeWidget.prototype._contextmenu=function(e){var $div,node;$div=$(e.target).closest("ul.jqtree-tree .jqtree-element");if($div.length){node=this._getNode($div);if(node)return e.preventDefault(),e.stopPropagation(),this._triggerEvent("tree.contextmenu",{node:node,click_event:e}),!1}},JqTreeWidget.prototype._saveState=function(){if(this.options.saveState)return this.save_state_handler.saveState()},JqTreeWidget.prototype._mouseCapture=function(position_info){return this.options.dragAndDrop?this.dnd_handler.mouseCapture(position_info):!1},JqTreeWidget.prototype._mouseStart=function(position_info){return this.options.dragAndDrop?this.dnd_handler.mouseStart(position_info):!1},JqTreeWidget.prototype._mouseDrag=function(position_info){var result;return this.options.dragAndDrop?(result=this.dnd_handler.mouseDrag(position_info),this.scroll_handler&&this.scroll_handler.checkScrolling(),result
):!1},JqTreeWidget.prototype._mouseStop=function(position_info){return this.options.dragAndDrop?this.dnd_handler.mouseStop(position_info):!1},JqTreeWidget.prototype._triggerEvent=function(event_name,values){var event;return event=$.Event(event_name),$.extend(event,values),this.element.trigger(event),event},JqTreeWidget.prototype.testGenerateHitAreas=function(moving_node){return this.dnd_handler.current_item=this._getNodeElementForNode(moving_node),this.dnd_handler.generateHitAreas(),this.dnd_handler.hit_areas},JqTreeWidget.prototype._selectCurrentNode=function(){var node,node_element;node=this.getSelectedNode();if(node){node_element=this._getNodeElementForNode(node);if(node_element)return node_element.select()}},JqTreeWidget.prototype._deselectCurrentNode=function(){var node;node=this.getSelectedNode();if(node)return this.removeFromSelection(node)},JqTreeWidget}(MouseWidget),SimpleWidget.register(JqTreeWidget,"tree"),NodeElement=function(){function NodeElement(node,tree_widget){this.init(node,tree_widget)}return NodeElement.prototype.init=function(node,tree_widget){return this.node=node,this.tree_widget=tree_widget,node.element||(node.element=this.tree_widget.element),this.$element=$(node.element)},NodeElement.prototype.getUl=function(){return this.$element.children("ul:first")},NodeElement.prototype.getSpan=function(){return this.$element.children(".jqtree-element").find("span.jqtree-title")},NodeElement.prototype.getLi=function(){return this.$element},NodeElement.prototype.addDropHint=function(position){return position===Position.INSIDE?new BorderDropHint(this.$element):new GhostDropHint(this.node,this.$element,position)},NodeElement.prototype.select=function(){return this.getLi().addClass("jqtree-selected")},NodeElement.prototype.deselect=function(){return this.getLi().removeClass("jqtree-selected")},NodeElement}(),FolderElement=function(_super){function FolderElement(){return FolderElement.__super__.constructor.apply(this,arguments)}return __extends(FolderElement,_super),FolderElement.prototype.open=function(on_finished,slide){var $button,doOpen;slide==null&&(slide=!0);if(!this.node.is_open)return this.node.is_open=!0,$button=this.getButton(),$button.removeClass("jqtree-closed"),$button.html(""),$button.append(this.tree_widget.renderer.opened_icon_element.cloneNode()),doOpen=function(_this){return function(){return _this.getLi().removeClass("jqtree-closed"),on_finished&&on_finished(),_this.tree_widget._triggerEvent("tree.open",{node:_this.node})}}(this),slide?this.getUl().slideDown("fast",doOpen):(this.getUl().show(),doOpen())},FolderElement.prototype.close=function(slide){var $button,doClose;slide==null&&(slide=!0);if(this.node.is_open)return this.node.is_open=!1,$button=this.getButton(),$button.addClass("jqtree-closed"),$button.html(""),$button.append(this.tree_widget.renderer.closed_icon_element.cloneNode()),doClose=function(_this){return function(){return _this.getLi().addClass("jqtree-closed"),_this.tree_widget._triggerEvent("tree.close",{node:_this.node})}}(this),slide?this.getUl().slideUp("fast",doClose):(this.getUl().hide(),doClose())},FolderElement.prototype.getButton=function(){return this.$element.children(".jqtree-element").find("a.jqtree-toggler")},FolderElement.prototype.addDropHint=function(position){return!this.node.is_open&&position===Position.INSIDE?new BorderDropHint(this.$element):new GhostDropHint(this.node,this.$element,position)},FolderElement}(NodeElement),html_escape=function(string){return(""+string).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;")},_indexOf=function(array,item){var i,value,_i,_len;for(i=_i=0,_len=array.length;_i<_len;i=++_i){value=array[i];if(value===item)return i}return-1},indexOf=function(array,item){return array.indexOf?array.indexOf(item):_indexOf(array,item)},this.Tree.indexOf=indexOf,this.Tree._indexOf=_indexOf,isInt=function(n){return typeof n=="number"&&n%1===0},get_json_stringify_function=function(){var json_escapable,json_meta,json_quote,json_str,stringify;return json_escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,json_meta={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},json_quote=function(string){return json_escapable.lastIndex=0,json_escapable.test(string)?'"'+string.replace(json_escapable,function(a){var c;return c=json_meta[a],typeof c=="string"?c:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+string+'"'},json_str=function(key,holder){var i,k,partial,v,value,_i,_len;value=holder[key];switch(typeof value){case"string":return json_quote(value);case"number":return isFinite(value)?String(value):"null";case"boolean":case"null":return String(value);case"object":if(!value)return"null";partial=[];if(Object.prototype.toString.apply(value)==="[object Array]"){for(i=_i=0,_len=value.length;_i<_len;i=++_i)v=value[i],partial[i]=json_str(i,value)||"null";return partial.length===0?"[]":"["+partial.join(",")+"]"}for(k in value)Object.prototype.hasOwnProperty.call(value,k)&&(v=json_str(k,value),v&&partial.push(json_quote(k)+":"+v));return partial.length===0?"{}":"{"+partial.join(",")+"}"}},stringify=function(value){return json_str("",{"":value})},stringify},this.Tree.get_json_stringify_function=get_json_stringify_function;if(this.JSON==null||this.JSON.stringify==null||typeof this.JSON.stringify!="function")this.JSON==null&&(this.JSON={}),this.JSON.stringify=get_json_stringify_function();SaveStateHandler=function(){function SaveStateHandler(tree_widget){this.tree_widget=tree_widget}return SaveStateHandler.prototype.saveState=function(){var state;state=JSON.stringify(this.getState());if(this.tree_widget.options.onSetStateFromStorage)return this.tree_widget.options.onSetStateFromStorage(state);if(this.supportsLocalStorage())return localStorage.setItem(this.getCookieName(),state);if($.cookie)return $.cookie.raw=!0,$.cookie(this.getCookieName(),state,{path:"/"})},SaveStateHandler.prototype.restoreState=function(){var state;return state=this.getStateFromStorage(),state?(this.setState(state),!0):!1},SaveStateHandler.prototype.getStateFromStorage=function(){var json_data;return json_data=this._loadFromStorage(),json_data?this._parseState(json_data):null},SaveStateHandler.prototype._parseState=function(json_data){var state;return state=$.parseJSON(json_data),state&&state.selected_node&&isInt(state.selected_node)&&(state.selected_node=[state.selected_node]),state},SaveStateHandler.prototype._loadFromStorage=function(){return this.tree_widget.options.onGetStateFromStorage?this.tree_widget.options.onGetStateFromStorage():this.supportsLocalStorage()?localStorage.getItem(this.getCookieName()):$.cookie?($.cookie.raw=!0,$.cookie(this.getCookieName())):null},SaveStateHandler.prototype.getState=function(){var getOpenNodeIds,getSelectedNodeIds;return getOpenNodeIds=function(_this){return function(){var open_nodes;return open_nodes=[],_this.tree_widget.tree.iterate(function(node){return node.is_open&&node.id&&node.hasChildren()&&open_nodes.push(node.id),!0}),open_nodes}}(this),getSelectedNodeIds=function(_this){return function(){var n;return function(){var _i,_len,_ref,_results;_ref=this.tree_widget.getSelectedNodes(),_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++)n=_ref[_i],_results.push(n.id);return _results}.call(_this)}}(this),{open_nodes:getOpenNodeIds(),selected_node:getSelectedNodeIds()}},SaveStateHandler.prototype.setState=function(state){var node_id,open_nodes,selected_node,selected_node_ids,_i,_len,_results;if(state){open_nodes=state.open_nodes,selected_node_ids=state.selected_node,this.tree_widget.tree.iterate(function(_this){return function(node){return node.is_open=node.id&&node.hasChildren()&&indexOf(open_nodes,node.id)>=0,!0}}(this));if(selected_node_ids&&this.tree_widget.select_node_handler){this.tree_widget.select_node_handler.clear(),_results=[];for(_i=0,_len=selected_node_ids.length;_i<_len;_i++)node_id=selected_node_ids[_i],selected_node=this.tree_widget.getNodeById(node_id),selected_node?_results.push(this.tree_widget.select_node_handler.addToSelection(selected_node)):_results.push(void 0);return _results}}},SaveStateHandler.prototype.getCookieName=function(){return typeof this.tree_widget.options.saveState=="string"?this.tree_widget.options.saveState:"tree"},SaveStateHandler.prototype.supportsLocalStorage=function(){var testSupport;return testSupport=function(){var error,key;if(typeof localStorage=="undefined"||localStorage===null)return!1;try{key="_storage_test",sessionStorage.setItem(key,!0),sessionStorage.removeItem(key)}catch(_error){return error=_error,!1}return!0},this._supportsLocalStorage==null&&(this._supportsLocalStorage=testSupport()),this._supportsLocalStorage},SaveStateHandler.prototype.getNodeIdToBeSelected=function(){var state;return state=this.getStateFromStorage(),state&&state.selected_node?state.selected_node[0]:null},SaveStateHandler}(),SelectNodeHandler=function(){function SelectNodeHandler(tree_widget){this.tree_widget=tree_widget,this.clear()}return SelectNodeHandler.prototype.getSelectedNode=function(){var selected_nodes;return selected_nodes=this.getSelectedNodes(),selected_nodes.length?selected_nodes[0]:!1},SelectNodeHandler.prototype.getSelectedNodes=function(){var id,node,selected_nodes;if(this.selected_single_node)return[this.selected_single_node];selected_nodes=[];for(id in this.selected_nodes)node=this.tree_widget.getNodeById(id),node&&selected_nodes.push(node);return selected_nodes},SelectNodeHandler.prototype.getSelectedNodesUnder=function(parent){var id,node,selected_nodes;if(this.selected_single_node)return parent.isParentOf(this.selected_single_node)?[this.selected_single_node]:[];selected_nodes=[];for(id in this.selected_nodes)node=this.tree_widget.getNodeById(id),node&&parent.isParentOf(node)&&selected_nodes.push(node);return selected_nodes},SelectNodeHandler.prototype.isNodeSelected=function(node){return node.id?this.selected_nodes[node.id]:this.selected_single_node?this.selected_single_node.element===node.element:!1},SelectNodeHandler.prototype.clear=function(){return this.selected_nodes={},this.selected_single_node=null},SelectNodeHandler.prototype.removeFromSelection=function(node,include_children){include_children==null&&(include_children=!1);if(!node.id){if(this.selected_single_node&&node.element===this.selected_single_node.element)return this.selected_single_node=null}else{delete this.selected_nodes[node.id];if(include_children)return node.iterate(function(_this){return function(n){return delete _this.selected_nodes[node.id],!0}}(this))}},SelectNodeHandler.prototype.addToSelection=function(node){return node.id?this.selected_nodes[node.id]=!0:this.selected_single_node=node},SelectNodeHandler}(),DragAndDropHandler=function(){function DragAndDropHandler(tree_widget){this.tree_widget=tree_widget,this.hovered_area=null,this.$ghost=null,this.hit_areas=[],this.is_dragging=!1,this.current_item=null}return DragAndDropHandler.prototype.mouseCapture=function(position_info){var $element,node_element;return $element=$(position_info.target),this.mustCaptureElement($element)?this.tree_widget.options.onIsMoveHandle&&!this.tree_widget.options.onIsMoveHandle($element)?null:(node_element=this.tree_widget._getNodeElement($element),node_element&&this.tree_widget.options.onCanMove&&(this.tree_widget.options.onCanMove(node_element.node)||(node_element=null)),this.current_item=node_element,this.current_item!==null):null},DragAndDropHandler.prototype.mouseStart=function(position_info){var offset;return this.refresh(),offset=$(position_info.target).offset(),this.drag_element=new DragElement(this.current_item.node,position_info.page_x-offset.left,position_info.page_y-offset.top,this.tree_widget.element),this.is_dragging=!0,this.current_item.$element.addClass("jqtree-moving"),!0},DragAndDropHandler.prototype.mouseDrag=function(position_info){var area,can_move_to;return this.drag_element.move(position_info.page_x,position_info.page_y),area=this.findHoveredArea(position_info.page_x,position_info.page_y),can_move_to=this.canMoveToArea(area),can_move_to&&area?(area.node.isFolder()||this.stopOpenFolderTimer(),this.hovered_area!==area&&(this.hovered_area=area,this.mustOpenFolderTimer(area)?this.startOpenFolderTimer(area.node):this.stopOpenFolderTimer(),this.updateDropHint())):(this.removeHover(),this.removeDropHint(),this.stopOpenFolderTimer()),!0},DragAndDropHandler.prototype.mustCaptureElement=function($element){return!$element.is("input,select")},DragAndDropHandler.prototype.canMoveToArea=function(area){var position_name;return area?this.tree_widget.options.onCanMoveTo?(position_name=Position.getName(area.position),this.tree_widget.options.onCanMoveTo(this.current_item.node,area.node,position_name)):!0:!1},DragAndDropHandler.prototype.mouseStop=function(position_info){return this.moveItem(position_info),this.clear(),this.removeHover(),this.removeDropHint(),this.removeHitAreas(),this.current_item&&(this.current_item.$element.removeClass("jqtree-moving"),this.current_item=null),this.is_dragging=!1,!1},DragAndDropHandler.prototype.refresh=function(){this.removeHitAreas();if(this.current_item){this.generateHitAreas(),this.current_item=this.tree_widget._getNodeElementForNode(this.current_item.node);if(this.is_dragging)return this.current_item.$element.addClass("jqtree-moving")}},DragAndDropHandler.prototype.removeHitAreas=function(){return this.hit_areas=[]},DragAndDropHandler.prototype.clear=function(){return this.drag_element.remove(),this.drag_element=null},DragAndDropHandler.prototype.removeDropHint=function(){if(this.previous_ghost)return this.previous_ghost.remove()},DragAndDropHandler.prototype.removeHover=function(){return this.hovered_area=null},DragAndDropHandler.prototype.generateHitAreas=function(){var hit_areas_generator;return hit_areas_generator=new HitAreasGenerator(this.tree_widget.tree,this.current_item.node,this.getTreeDimensions().bottom),this.hit_areas=hit_areas_generator.generate()},DragAndDropHandler.prototype.findHoveredArea=function(x,y){var area,dimensions,high,low,mid;dimensions=this.getTreeDimensions();if(x<dimensions.left||y<dimensions.top||x>dimensions.right||y>dimensions.bottom)return null;low=0,high=this.hit_areas.length;while(low<high){mid=low+high>>1,area=this.hit_areas[mid];if(y<area.top)high=mid;else{if(!(y>area.bottom))return area;low=mid+1}}return null},DragAndDropHandler.prototype.mustOpenFolderTimer=function(area){var node;return node=area.node,node.isFolder()&&!node.is_open&&area.position===Position.INSIDE},DragAndDropHandler.prototype.updateDropHint=function(){var node_element;if(!this.hovered_area)return;return this.removeDropHint(),node_element=this.tree_widget._getNodeElementForNode(this.hovered_area.node),this.previous_ghost=node_element.addDropHint(this.hovered_area.position)},DragAndDropHandler.prototype.startOpenFolderTimer=function(folder){var openFolder;return openFolder=function(_this){return function(){return _this.tree_widget._openNode(folder,_this.tree_widget.options.slide,function(){return _this.refresh(),_this.updateDropHint()})}}(this),this.stopOpenFolderTimer(),this.open_folder_timer=setTimeout(openFolder,this.tree_widget.options.openFolderDelay)},DragAndDropHandler.prototype.stopOpenFolderTimer=function(){if(this.open_folder_timer)return clearTimeout(this.open_folder_timer),this.open_folder_timer=null},DragAndDropHandler.prototype.moveItem=function(position_info){var doMove,event,moved_node,position,previous_parent,target_node;if(this.hovered_area&&this.hovered_area.position!==Position.NONE&&this.canMoveToArea(this.hovered_area)){moved_node=this.current_item.node,target_node=this.hovered_area.node,position=this.hovered_area.position,previous_parent=moved_node.parent,position===Position.INSIDE&&(this.hovered_area.node.is_open=!0),doMove=function(_this){return function(){return _this.tree_widget.tree.moveNode(moved_node,target_node,position),_this.tree_widget.element.empty(),_this.tree_widget._refreshElements()}}(this),event=this.tree_widget._triggerEvent("tree.move",{move_info:{moved_node:moved_node,target_node:target_node,position:Position.getName(position),previous_parent:previous_parent,do_move:doMove,original_event:position_info.original_event}});if(!event.isDefaultPrevented())return doMove()}},DragAndDropHandler.prototype.getTreeDimensions=function(){var offset;return offset=this.tree_widget.element.offset(),{left:offset.left,top:offset.top,right:offset.left+this.tree_widget.element.width(),bottom:offset.top+this.tree_widget.element.height()+16}},DragAndDropHandler}(),VisibleNodeIterator=function(){function VisibleNodeIterator(tree){this.tree=tree}return VisibleNodeIterator.prototype.iterate=function(){var is_first_node,_iterateNode;return is_first_node=!0,_iterateNode=function(_this){return function(node,next_node){var $element,child,children_length,i,must_iterate_inside,_i,_len,_ref;must_iterate_inside=(node.is_open||!node.element)&&node.hasChildren();if(node.element){$element=$(node.element);if(!$element.is(":visible"))return;is_first_node&&(_this.handleFirstNode(node,$element),is_first_node=!1),node.hasChildren()?node.is_open?_this.handleOpenFolder(node,$element)||(must_iterate_inside=!1):_this.handleClosedFolder(node,next_node,$element):_this.handleNode(node,next_node,$element)}if(must_iterate_inside){children_length=node.children.length,_ref=node.children;for(i=_i=0,_len=_ref.length;_i<_len;i=++_i)child=_ref[i],i===children_length-1?_iterateNode(node.children[i],null):_iterateNode(node.children[i],node.children[i+1]);if(node.is_open)return _this.handleAfterOpenFolder(node,next_node,$element)}}}(this),_iterateNode(this.tree,null)},VisibleNodeIterator.prototype.handleNode=function(node,next_node,$element){},VisibleNodeIterator.prototype.handleOpenFolder=function(node,$element){},VisibleNodeIterator.prototype.handleClosedFolder=function(node,next_node,$element){},VisibleNodeIterator.prototype.handleAfterOpenFolder=function(node,next_node,$element){},VisibleNodeIterator.prototype.handleFirstNode=function(node,$element){},VisibleNodeIterator}(),HitAreasGenerator=function(_super){function HitAreasGenerator(tree,current_node,tree_bottom){HitAreasGenerator.__super__.constructor.call(this,tree),this.current_node=current_node,this.tree_bottom=tree_bottom}return __extends(HitAreasGenerator,_super),HitAreasGenerator.prototype.generate=function(){return this.positions=[],this.last_top=0,this.iterate(),this.generateHitAreas(this.positions)},HitAreasGenerator.prototype.getTop=function($element){return $element.offset().top},HitAreasGenerator.prototype.addPosition=function(node,position,top){var area;return area={top:top,node:node,position:position},this.positions.push(area),this.last_top=top},HitAreasGenerator.prototype.handleNode=function(node,next_node,$element){var top;return top=this.getTop($element),node===this.current_node?this.addPosition(node,Position.NONE,top):this.addPosition(node,Position.INSIDE,top),next_node===this.current_node||node===this.current_node?this.addPosition(node,Position.NONE,top):this.addPosition(node,Position.AFTER,top)},HitAreasGenerator.prototype.handleOpenFolder=function(node,$element){return node===this.current_node?!1:(node.children[0]!==this.current_node&&this.addPosition(node,Position.INSIDE,this.getTop($element)),!0)},HitAreasGenerator.prototype.handleClosedFolder=function(node,next_node,$element){var top;top=this.getTop($element);if(node===this.current_node)return this.addPosition(node,Position.NONE,top);this.addPosition(node,Position.INSIDE,top);if(next_node!==this.current_node)return this.addPosition(node,Position.AFTER,top)},HitAreasGenerator.prototype.handleFirstNode=function(node,$element){if(node!==this.current_node)return this.addPosition(node,Position.BEFORE,this.getTop($(node.element)))},HitAreasGenerator.prototype.handleAfterOpenFolder=function(node,next_node,$element){return node===this.current_node.node||next_node===this.current_node.node?this.addPosition(node,Position.NONE,this.last_top):this.addPosition(node,Position.AFTER,this.last_top)},HitAreasGenerator.prototype.generateHitAreas=function(positions){var group,hit_areas,position,previous_top,_i,_len;previous_top=-1,group=[],hit_areas=[];for(_i=0,_len=positions.length;_i<_len;_i++)position=positions[_i],position.top!==previous_top&&group.length&&(group.length&&this.generateHitAreasForGroup(hit_areas,group,previous_top,position.top),previous_top=position.top,group=[]),group.push(position);return this.generateHitAreasForGroup(hit_areas,group,previous_top,this.tree_bottom),hit_areas},HitAreasGenerator.prototype.generateHitAreasForGroup=function(hit_areas,positions_in_group,top,bottom){var area_height,area_top,i,position,position_count;position_count=Math.min(positions_in_group.length,4),area_height=Math.round((bottom-top)/position_count),area_top=top,i=0;while(i<position_count)position=positions_in_group[i],hit_areas.push({top:area_top,bottom:area_top+area_height,node:position.node,position:position.position}),area_top+=area_height,i+=1;return null},HitAreasGenerator}(VisibleNodeIterator),DragElement=function(){function DragElement(node,offset_x,offset_y,$tree){this.offset_x=offset_x,this.offset_y=offset_y,this.$element=$('<span class="jqtree-title jqtree-dragging">'+node.name+"</span>"),this.$element.css("position","absolute"),$tree.append(this.$element)}return DragElement.prototype.move=function(page_x,page_y){return this.$element.offset({left:page_x-this.offset_x,top:page_y-this.offset_y})},DragElement.prototype.remove=function(){return this.$element.remove()},DragElement}(),GhostDropHint=function(){function GhostDropHint(node,$element,position){this.$element=$element,this.node=node,this.$ghost=$('<li class="jqtree_common jqtree-ghost"><span class="jqtree_common jqtree-circle"></span><span class="jqtree_common jqtree-line"></span></li>'),position===Position.AFTER?this.moveAfter():position===Position.BEFORE?this.moveBefore():position===Position.INSIDE&&(node.isFolder()&&node.is_open?this.moveInsideOpenFolder():this.moveInside())}return GhostDropHint.prototype.remove=function(){return this.$ghost.remove()},GhostDropHint.prototype.moveAfter=function(){return this.$element.after(this.$ghost)},GhostDropHint.prototype.moveBefore=function(){return this.$element.before(this.$ghost)},GhostDropHint.prototype.moveInsideOpenFolder=function(){return $(this.node.children[0].element).before(this.$ghost)},GhostDropHint.prototype.moveInside=function(){return this.$element.after(this.$ghost),this.$ghost.addClass("jqtree-inside")},GhostDropHint}(),BorderDropHint=function(){function BorderDropHint($element){var $div,width;$div=$element.children(".jqtree-element"),width=$element.width()-4,this.$hint=$('<span class="jqtree-border"></span>'),$div.append(this.$hint),this.$hint.css({width:width,height:$div.height()-4})}return BorderDropHint.prototype.remove=function(){return this.$hint.remove()},BorderDropHint}(),ScrollHandler=function(){function ScrollHandler(tree_widget){this.tree_widget=tree_widget,this.previous_top=-1,this._initScrollParent()}return ScrollHandler.prototype._initScrollParent=function(){var $scroll_parent,getParentWithOverflow,setDocumentAsScrollParent;return getParentWithOverflow=function(_this){return function(){var css_values,el,hasOverFlow,_i,_len,_ref;css_values=["overflow","overflow-y"],hasOverFlow=function(el){var css_value,_i,_len,_ref;for(_i=0,_len=css_values.length;_i<_len;_i++){css_value=css_values[_i];if((_ref=$.css(el,css_value))==="auto"||_ref==="scroll")return!0}return!1};if(hasOverFlow(_this.tree_widget.$el[0]))return _this.tree_widget.$el;_ref=_this.tree_widget.$el.parents();for(_i=0,_len=_ref.length;_i<_len;_i++){el=_ref[_i];if(hasOverFlow(el))return $(el)}return null}}(this),setDocumentAsScrollParent=function(_this){return function(){return _this.scroll_parent_top=0,_this.$scroll_parent=null}}(this),this.tree_widget.$el.css("position")==="fixed"&&setDocumentAsScrollParent(),$scroll_parent=getParentWithOverflow(),$scroll_parent&&$scroll_parent.length&&$scroll_parent[0].tagName!=="HTML"?(this.$scroll_parent=$scroll_parent,this.scroll_parent_top=this.$scroll_parent.offset().top):setDocumentAsScrollParent()},ScrollHandler.prototype.checkScrolling=function(){var hovered_area;hovered_area=this.tree_widget.dnd_handler.hovered_area;if(hovered_area&&hovered_area.top!==this.previous_top)return this.previous_top=hovered_area.top,this.$scroll_parent?this._handleScrollingWithScrollParent(hovered_area):this._handleScrollingWithDocument(hovered_area)},ScrollHandler.prototype._handleScrollingWithScrollParent=function(area){var distance_bottom;distance_bottom=this.scroll_parent_top+this.$scroll_parent[0].offsetHeight-area.bottom;if(distance_bottom<20)return this.$scroll_parent[0].scrollTop+=20,this.tree_widget.refreshHitAreas(),this.previous_top=-1;if(area.top-this.scroll_parent_top<20)return this.$scroll_parent[0].scrollTop-=20,this.tree_widget.refreshHitAreas(),this.previous_top=-1},ScrollHandler.prototype._handleScrollingWithDocument=function(area){var distance_top;distance_top=area.top-$(document).scrollTop();if(distance_top<20)return $(document).scrollTop($(document).scrollTop()-20);if($(window).height()-(area.bottom-$(document).scrollTop())<20)return $(document).scrollTop($(document).scrollTop()+20)},ScrollHandler.prototype.scrollTo=function(top){var tree_top;return this.$scroll_parent?this.$scroll_parent[0].scrollTop=top:(tree_top=this.tree_widget.$el.offset().top,$(document).scrollTop(top+tree_top))},ScrollHandler.prototype.isScrolledIntoView=function(element){var $element,element_bottom,element_top,view_bottom,view_top;return $element=$(element),this.$scroll_parent?(view_top=0,view_bottom=this.$scroll_parent.height(),element_top=$element.offset().top-this.scroll_parent_top,element_bottom=element_top+$element.height()):(view_top=$(window).scrollTop(),view_bottom=view_top+$(window).height(),element_top=$element.offset().top,element_bottom=element_top+$element.height()),element_bottom<=view_bottom&&element_top>=view_top},ScrollHandler}(),KeyHandler=function(){function KeyHandler(tree_widget){this.tree_widget=tree_widget,tree_widget.options.keyboardSupport&&$(document).bind("keydown.jqtree",$.proxy(this.handleKeyDown,this))}var DOWN,LEFT,RIGHT,UP;return LEFT=37,UP=38,RIGHT=39,DOWN=40,KeyHandler.prototype.deinit=function(){return $(document).unbind("keydown.jqtree")},KeyHandler.prototype.handleKeyDown=function(e){var current_node,key,moveDown,moveLeft,moveRight,moveUp,selectNode;if(!this.tree_widget.options.keyboardSupport)return;if($(document.activeElement).is("textarea,input,select"))return!0;current_node=this.tree_widget.getSelectedNode(),selectNode=function(_this){return function(node){return node?(_this.tree_widget.selectNode(node),_this.tree_widget.scroll_handler&&!_this.tree_widget.scroll_handler.isScrolledIntoView($(node.element).find(".jqtree-element"))&&_this.tree_widget.scrollToNode(node),!1):!0}}(this),moveDown=function(_this){return function(){return selectNode(_this.getNextNode(current_node))}}(this),moveUp=function(_this){return function(){return selectNode(_this.getPreviousNode(current_node))}}(this),moveRight=function(_this){return function(){return current_node.isFolder()&&!current_node.is_open?(_this.tree_widget.openNode(current_node),!1):!0}}(this),moveLeft=function(_this){return function(){return current_node.isFolder()&&current_node.is_open?(_this.tree_widget.closeNode(current_node),!1):!0}}(this);if(!current_node)return!0;key=e.which;switch(key){case DOWN:return moveDown();case UP:return moveUp();case RIGHT:return moveRight();case LEFT:return moveLeft()}},KeyHandler.prototype.getNextNode=function(node,include_children){var next_sibling;return include_children==null&&(include_children=!0),include_children&&node.hasChildren()&&node.is_open?node.children[0]:node.parent?(next_sibling=node.getNextSibling(),next_sibling?next_sibling:this.getNextNode(node.parent,!1)):null},KeyHandler.prototype.getPreviousNode=function(node){var previous_sibling;return node.parent?(previous_sibling=node.getPreviousSibling(),previous_sibling?!previous_sibling.hasChildren()||!previous_sibling.is_open?previous_sibling:this.getLastChild(previous_sibling):node.parent.parent?node.parent:null):null},KeyHandler.prototype.getLastChild=function(node){var last_child;return node.hasChildren()?(last_child=node.children[node.children.length-1],!last_child.hasChildren()||!last_child.is_open?last_child:this.getLastChild(last_child)):null},KeyHandler}()}).call(this);