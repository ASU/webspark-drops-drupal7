<?php
/**
 * Holds some various Webspark features/modules in this module's subdirectories
 * Activates theme specific modules & configuration on theme changes
 * Alters Update Status lists/notifications for Webspark-containing projects
 */

/**
 * Implements hook_menu_alter() - builds on existing menu callback
 */
function webspark_featurescustom_menu_alter (&$items) {
  // Modifying callback for theme selection function to include our own functionality
  $items['admin/appearance/default']['page callback'] = '_webspark_featurescustom_theme_check';
}

/**
 * Custom menu callback for when the theme is changed to handle various config
 * changes related to ASU Web Standards.
 *
 * @TODO - Put in check to see if certain settings are already in place before module_load_include...s
 */
function _webspark_featurescustom_theme_check() {
  // Checking if the selected theme is our theme & calling function to active modules/configuration
  module_load_include('inc', 'system', 'system.admin.inc');
  $new_theme = check_plain($_REQUEST['theme']);

  $asu_base_theme = _webspark_featurescustom_get_base_theme($new_theme);
  if ($asu_base_theme) {
    _webspark_featurescustom_enable_config($new_theme);
  }
  // WEBSPARK-610 - Settings for when Innovation or asu_webspark_bootstrap
  elseif (!$asu_base_theme && $new_theme !== 'asu_webspark_bootstrap') {
    _webspark_featurescustom_alt_theme_config($new_theme);
  }
  system_theme_default();
}

/**
 * Theme update callback - On theme change from any theme to Innovation theme
 * @TODO - Centralize the header version number location
 */
function _webspark_featurescustom_enable_config($theme) {
  // Enabling Innovation-related modules if they are not enabled
  $modules = array();
  $modules_to_enable = array();
  // Contrib module dependencies for features
  $modules[] = 'backgroundfield';
  $modules[] = 'chosen';
  $modules[] = 'easy_breadcrumb';
  $modules[] = 'entity_view_mode';
  $modules[] = 'flexslider';
  $modules[] = 'fontawesome';
  $modules[] = 'google_appliance';
  $modules[] = 'maxlength';
  $modules[] = 'panels_tabs';
  $modules[] = 'uuid_features';
  $modules[] = 'video_embed_field';
  $modules[] = 'wysiwyg_template';
  $modules[] = 'asu_spotlight';
  $modules[] = 'mega_footer';
  // OpenASU custom modules, features - keep this up with openasu.info
  $modules[] = 'asu_gsa';
  $modules[] = 'asu_maps_enhanced';
  $modules[] = 'asu_spotlight';
  $modules[] = 'asu_securityscanfixes';
  $modules[] = 'webspark_wysiwyg';
  $modules[] = 'webspark_panels_styles';
  $modules[] = 'webspark_banner';
  $modules[] = 'webspark_breadcrumbs';
  $modules[] = 'webspark_content_callout';
  $modules[] = 'webspark_easyadmin';
  $modules[] = 'webspark_hero';
  $modules[] = 'webspark_jumbohero';
  $modules[] = 'webspark_megamenu';
  $modules[] = 'mega_footer_menu';
  $modules[] = 'webspark_extras';

  // Enable disabled modules
  foreach($modules as $module) {
    if (!module_exists($module)) {
      $modules_to_enable[] = $module;
    }
  }

  if (count($modules_to_enable) > 0) {
    try {
      module_enable($modules_to_enable);
      drupal_set_message('Modules enabled for <em>' . t($theme) . '</em> - ' . implode(', ', $modules_to_enable));
      watchdog('theme update', 'Modules enabled for %theme theme - ' . implode(', ', $modules_to_enable), array('%theme' => $theme));
    }
    catch (Exception $e) {
      watchdog('theme update', 'Innovation module dependency enabling failed: ' . $e->getMessage(), WATCHDOG_ERROR);
      drupal_set_message('The enabling of Innovation theme-specific modules may have failed. Check your <a href="/admin/reports/dblog">recent log messages</a> for details.', 'error');
    }
  }
  else {
    watchdog('theme update', 'All modules already enabled for %theme theme, so no module_enable action taken.', array('%theme' => $theme));
  }

  // WEBSPARK-448, 509
  // Add setting for updating header to proper version
  variable_set('asu_brand_header_version', '4.3');
  // Update header file name to default
  variable_set('asu_brand_header_template', 'default');
  // Update header basepath
  variable_set('asu_brand_header_basepath', 'http://www.asu.edu/asuthemes');
  watchdog('theme update', 'Updated ASU Header values for %theme theme', array('%theme' => $theme));

  // WEBSPARK-610 - Re-apply original block configs to ensure their proper location
  // to match spinup settings.
  // function openasu_blockupdates_for_theme() in openasu.profile
  if (function_exists('openasu_blockupdates_for_theme')) {
    openasu_blockupdates_for_theme($theme);
  }

  // WEBSPARK-509 - Swap out system main-menu with TB Mega Menu main-menu on
  // theme update. (#610 - updated queries to Database API)
  if (module_exists('tb_megamenu') && module_exists('webspark_megamenu')) {
    db_update('block')
      ->fields(array(
          'region' => 'menu',
          'status' => '1',
          'weight' => '-100'
        )
      )
      ->condition('module', 'tb_megamenu')
      ->condition('delta', 'main-menu')
      ->execute();
    db_update('block')
      ->fields(array(
          'region' => '-1',
          'status' => '0',
          'weight' => '0'
        )
      )
      ->condition('module', 'system')
      ->condition('delta', 'main-menu')
      ->execute();
    // disable ASU Students block
    db_update('block')
      ->fields(array(
          'region' => '-1',
          'status' => '0',
          'weight' => '0'
        )
      )
      ->condition('module', 'asu_brand')
      ->condition('delta', 'asu_brand_students_footer')
      ->execute();
  }
  // Flush ASU Brand caches so ASU headers are right
  asu_brand_cache_clear();
  // Log changes
  drupal_set_message('Enabled Web Standards-themed blocks for <em>' . t($theme) . '</em> theme');
  watchdog('theme update', 'Enabled Web Standards-themed blocks for %theme theme', array('%theme' => $theme));
}

/**
 * Alternate callback for when Innovation is NOT selected - disable
 * Innovation-specific blocks.
 */
function _webspark_featurescustom_alt_theme_config($theme = NULL){
  if (is_null($theme)) { // callback from admin theme form
    $theme = variable_get('admin_theme');
    drupal_set_message($theme . ' selected as admininstrator theme');
    watchdog('theme update', '%theme selected as administrator theme', array('%theme' => $theme));
  }
  // Hide blocks for $theme
  db_update('block')
    ->fields(array(
        'region' => '-1',
        'status' => '0',
        'weight' => '0'
      )
    )
    ->condition('theme', $theme)
    ->condition(db_or()
      ->condition(db_and()
        ->condition('module', 'mega_footer')
        ->condition('delta', 'mega_footer')
      )
      ->condition(db_and()
        ->condition('module', 'asu_brand')
        ->condition('delta', 'asu_brand_footer')
      )
      ->condition(db_and()
        ->condition('module', 'asu_brand')
        ->condition('delta', 'asu_brand_header')
      )
      ->condition(db_and()
        ->condition('module', 'tb_megamenu')
        ->condition('delta', 'main-menu')
      )
    )
    ->execute();
  // Log changes
  drupal_set_message('Disabled Innovation-themed blocks for <em>' . t($theme) .
    '</em> theme. Go to the <a href="">blocks configuration</a> page to re-enable these blocks if desired.');
  watchdog('theme update', 'Disabled Web Standards-themed blocks for %theme theme.', array('%theme' => $theme));
}

/**
 * Implements hook_form_alter().
 */
function webspark_featurescustom_form_alter(&$form, &$form_state, $form_id) {
  // Admin theme selection form
  // + Add additional submission handler to end after manually running D7 core form submit
  if ($form_id == 'system_themes_admin_form') {
    $form['admin_theme']['actions']['submit']['#submit'][] = 'system_themes_admin_form_submit';
    $form['admin_theme']['actions']['submit']['#submit'][] = '_webspark_featurescustom_admin_theme';
  }
  // Content Page node form
  // + Remove feature fields from panopoly content page
  if ($form_id == 'panopoly_page_node_form') {
    $form['field_featured_image']['#access'] = FALSE;
    $form['field_featured_categories']['#access'] = FALSE;
    $form['field_featured_status']['#access'] = FALSE;
  }
  // Panels styles accordion settings form
  // + Set default configuration settings
  if ($form_id == 'panels_edit_style_settings_form') {
    $form['settings']['autoHeight']['#default_value'] = 0;
    $form['settings']['clearStyle']['#default_value'] = 1;
    $form['settings']['collapsible']['#default_value'] = 1;
    $form['settings']['fillSpace']['#default_value'] = 1;
  }
}

/**
 * Implements hook_form_submit()
 *
 * Custom submission handler for admin theme form.
 */
function _webspark_featurescustom_admin_theme($form, &$form_state) {
  $admin_theme = $form_state['values']['admin_theme']; // new admin theme
  $asu_base_theme = _webspark_featurescustom_get_base_theme($admin_theme);
  if ($asu_base_theme) {
    _webspark_featurescustom_enable_config($admin_theme);
  }
  // WEBSPARK-610 - Settings for when Innovation or asu_webspark_bootstrap
  elseif (!$asu_base_theme && $admin_theme !== 'asu_webspark_bootstrap') {
    _webspark_featurescustom_alt_theme_config($admin_theme);
  }
  system_theme_default();
}

/**
 * Is new theme an ASU theme or have an ASU base theme?
 * @param $theme - New theme selected
 * @returns TRUE or FALSE
 */
function _webspark_featurescustom_get_base_theme($theme) {
  $all_themes = list_themes();
  foreach ($all_themes as $name => $value) {
    if (!isset($value->base_theme)) {
      unset($all_themes[$name]); // remove themes with no base_theme.
    }
  }
  $base_themes = (in_array($theme, $all_themes)) ? drupal_find_base_themes($all_themes, $theme) : array();
  return ($theme === 'innovation' || in_array('innovation', $base_themes)) ? TRUE : FALSE;
}

/**
 * Implememtation of hook_system_info_alter()
 *
 * This is designed to update the subtheme from openasu_bootstrap to
 * asu_webspark_bootstrap as part of the 1.0 release.
 *
 * @TODO - Remove when Webspark Classic is removed.
 */
function webspark_featurescustom_system_info_alter(&$info, $file, $type) {
  if ($type == 'theme' && isset($info['base theme']) && $info['base theme'] == 'openasu_bootstrap') {
    $info['base theme'] = 'asu_webspark_bootstrap';
  }
}

/**
 * Implementation of hook_libraries_info_alter()
 *
 * This is designed to make sure that if a subtheme has been created before
 * Kalatheme 1.4 that we are connecting it to the default ASU Bootstrap
 * library. We also want to make sure that the user doesn't actually have a
 * correct Bootstrap library already set up for their subtheme.
 */
function webspark_featurescustom_libraries_info_alter(&$libraries) {
  global $theme_info;
  if (isset($theme_info->name) && isset($theme_info->base_theme)) {
    $library_path = DRUPAL_ROOT . '/sites/all/libraries/' . $theme_info->name . '_bootstrap/css/bootstrap.css';
    if ($theme_info->name != 'asu_webspark_bootstrap' && $theme_info->base_theme == 'asu_webspark_bootstrap' && !file_exists($library_path)) {
      $libraries[$theme_info->name . '_bootstrap']['machine name'] = 'asu_webspark_bootstrap_bootstrap';
    }
  }
}

/**
 * Implements hook_update_projects_alter()
 *
 * This function will remove any Webspark-managed project from
 * the core Drupal Update Manager.
 */
function webspark_featurescustom_update_projects_alter(&$projects) {
  // List of managed components to remove from update manager
  // WEBSPARK-639 - Update "Do Not Update" project list logic

  // First check to see if the current enabled modules and themes are in the
  // Webspark profile directory AND being used as the active, default codebase
  // for the module (vs. code elsewhere, such as sites/*, etc.)
  $managed_things = db_select('system', 's')
    ->fields('s', array('name', 'filename'))
    ->condition('status', 1)
    ->condition(db_or()
      ->condition('type', 'module')
      ->condition('type', 'theme')
    )
    ->condition('filename', 'profiles_openasu_%', 'LIKE')
    ->orderBy('name', 'ASC')
    ->execute()
    ->fetchCol();

  // Then add any dependencies to components managed by Webspark
  $profile_info = install_profile_info('openasu');
  foreach ($profile_info['dependencies'] as $module) {
    if (!in_array($module, $managed_things)) {  // Dupe check
      $managed_things[] = $module;
    }
    $module_info = drupal_parse_info_file(drupal_get_path('module', $module) . '/' . $module . '.info');
    if (!empty($module_info['dependencies'])) {
      foreach ($module_info['dependencies'] as $dependency) {
        $parts = explode(' (', $dependency, 2);
        $dependency_candidate = array_shift($parts);
        if (!in_array($dependency_candidate, $managed_things)) { // Dupe check
          $managed_things[] = $dependency_candidate;
        }
      }
    }
  }

  // Now remove modules and themes managed by distribution
  foreach ($managed_things as $managed_module) {
    unset($projects[$managed_module]);
  }
}

/**
 * Implements hook_update_status_alter()
 *
 * This function will remove any module managed by ASU WebSpark from
 * the list of modules in the Drupal Update Manager.
 */
function webspark_featurescustom_update_status_alter(&$projects) {
  // Don't want to unset this in hook_update_projects_later as per
  // https://drupal.org/node/1875386
  // But we do want to make sure the user isn't aware of updates through the GUI
  // so we mark as always up to date.
  foreach ($projects as $project_name => $project_info) {
    if ($project_name == 'drupal') {
      $projects[$project_name]['status'] = UPDATE_CURRENT;
      $projects[$project_name]['reason'] = t('Drupal core is managed by WebSpark. Do not update manually.');
    }
  }
}

/**
 * Implementation of hook_entity_info_alter()
 */
function webspark_featurescustom_entity_info_alter(&$entity_info) {
  // Changing name of Basic Image widget for clarity
  $entity_info['fieldable_panels_pane']['bundles']['image'] = array(
    'label' => t('Add responsive image'),
    'description' => t('Add 100%-wide responsive image'),
    'pane category' => t('Custom'),
    'pane top level' => TRUE,
    'pane icon' => drupal_get_path('module', 'panopoly_widgets') . '/images/icon_image.png',
    'admin' => array(
      'path' => 'admin/structure/fieldable-panels-panes/manage/%fieldable_panels_panes_type',
      'bundle argument' => 4,
      'real path' => 'admin/structure/fieldable-panels-panes/manage/image',
      'access arguments' => array('administer fieldable panels panes'),
    ),
  );

  // Changing description of Basic text for clarity
  $entity_info['fieldable_panels_pane']['bundles']['text'] = array(
    'label' => t('Add text'),
    'description' => t('Add text and media'),
    'pane category' => t('Custom'),
    'pane top level' => TRUE,
    'pane icon' => drupal_get_path('module', 'panopoly_widgets') . '/images/icon_text.png',
    'admin' => array(
      'path' => 'admin/structure/fieldable-panels-panes/manage/%fieldable_panels_panes_type',
      'bundle argument' => 4,
      'real path' => 'admin/structure/fieldable-panels-panes/manage/text',
      'access arguments' => array('administer fieldable panels panes'),
    ),
  );
}
